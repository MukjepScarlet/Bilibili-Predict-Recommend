# Bilibili 助手 (视频预测 & 视频推荐)

2023/12/28

由 Flask 框架构建的 Web 小工具, 能够提供的功能:
- 热门视频分析可视化 (2023年)
- 视频搜索/排序 (数据集)
- 视频热门预测 (任意视频)
- 视频个性化打分与推荐 (数据集)

这是大数据实践的作业项目.

## 构建运行环境 & 试运行

测试环境是 Windows 10 64位.

### Python 3 & lib
Python 3 需要添加到 PATH. 库可以直接使用 `pip` 命令安装.

### Hadoop for Windows
需要安装 JRE 1.8 或者 JDK 1.8, 需要添加到 PATH. 注意安装路径不要有空格, 比如 `Program Files`. 高版本可能不支持.

> 参考教程: [CSDN - Windows安装Hadoop3.x及在Windows环境下本地开发](https://blog.csdn.net/qq_38628046/article/details/124217768)

在 [GitHub - winutils](https://github.com/cdarlint/winutils/tree/master) 找到支持的最新的 Hadoop 版本 (测试使用 3.3.5)

下载之后去 [Hadoop 官网](https://archive.apache.org/dist/hadoop/common/) 下载对应的版本, 比如 [hadoop-3.3.5.tar.gz](https://archive.apache.org/dist/hadoop/common/hadoop-3.3.5/hadoop-3.3.5.tar.gz)

解压要求同 Java 的安装要求. 之后添加相应的环境变量, 并修改配置文件. 注意更改路径. 将上方 `winutils` 中的 `/bin` 目录覆盖掉 Hadoop 解压后的目录.

注意: 测试时修改 `hadoop-env.cmd` 并不能使用教程中 `set JAVA_HOME=%JAVA_HOME%` 的办法, 只能直接使用 `java.exe` 的路径, 并且不能使用双引号.

### 运行项目

测试 Hadoop 可以运行之后就可以启动项目了.

启动项目之前执行命令 `start-all` 启动 Hadoop 环境.

若使用 Linux 运行, 可能不需要 `predict.py` 和 `recommend.py` 中的环境变量配置 (未测试).

确认 Hadoop 环境运行正常.

将 `data` 文件夹下的三个数据集 (txt) 复制到 HDFS 上. 参考路径在 `recommend.py` 中.

在 `app.py` 底部修改启动方式, 可以公开内网访问.

执行 `app.py`, 之后可以正常使用各项功能.

## 项目配置文件简介

- 预测模型在 `GBT_model` 下.

- Hadoop 使用的数据集放在 `data` 文件夹下. 前端渲染使用的数据集放在 `static/bili` 文件夹下.

- 用户打分信息保存为 JSON, 在 `static/user_score` 下.

- 用户密码在前端 POST 时使用了密钥, 后端并不读取, 可以在 `static/login.js` 中修改.

- 登录信息使用 session 保存, 加密 `SECRET_KEY` 在 `app.py` 中修改.

- 用户账号数据保存使用了密钥, 在 `user.py` 中读取.

## 其他说明

- 使用了 `pyspark` 进行大量数据的处理统计, 最后使用 Python 的 `echart` 库对产生的数据进行图形的绘制再生成对应的 HTML 文件数据, 用模版渲染.

- 数据存储 & 分析: Spark 可以直接使用 Hadoop 的分布式文件系统 HDFS 来存储和访问数据. Spark 支持从 HDFS 中读取和写入数据,并可以利用 HDFS 的数据复制和容错机制来确保数据的可靠性. 本项目中设计的所有数据预处理到分析过程都是通过这些软件实现的.

- 提前使用当前拥有的所有数据训练一个AI模型, 即GBT_Model, 然后每次用户打开网页后后台开始加载模型, 用户输入的BV号/AV号会被制作成一个api地址并进行访问后获取相关数据, 将需要的各维度数据 (点赞, 播放量, 投币, 收藏等) 制作成一个特征向量让模型进行预测, 然后返回对应的预测结果后前端根据结果给出不同的响应.

- AI模型训练 & 推荐模型产生: 使用MLIB提供的一系列机器学习模型进行模型的训练, 其中预测模块通过尝试训练了逻辑回归算法, 决策树算法, 随机森林算法以及 GBT (梯度提升树) 算法后, 最终通过准确率选择了 GBT 模型作为预测模型进行使用. 其次是推荐模块, 使用的是 ALS 协同过滤算法进行分析并产生最终的推荐内容.

- 排序方式若设定为 "无", 翻页其实是没用的, 因为每次访问都会乱序. "逆序" 表示从大到小. 搜索关键词功能同时也会在简介里搜索.

- 打分的数据在用户输入完成时触发事件, 发送打分数据, 因此没有设定 "保存" 之类的功能. 后台收到含有打分数据的 POST 请求之后立刻写入相应的用户数据文件备用.

- 由于更新打分后训练需要一定时间 (测试端大约 20 秒), 所以采用多线程的方法, 在每次首页刷新时即时训练, 使用 ALS 协同过滤算法. 当次训练的结果会在之后访问首页时显示. 使用了一些状态判断来规避重复开启线程.

- 首页访问慢是因为在渲染时需要提前获取所有视频的在线观看人数, 发送的请求比较多, 所以有一些阻塞. Bilibili 自己是使用前端 JavaScript 定时获取的 (异步).

- 本项目经过一次大重构, 渲染方式由 JS 发送请求获取 JSON 转为直接使用 Flask 根据 URL 参数等方法渲染网页模板, 所以可能遗留了一些不需要 (未引用) 的代码.

- 没有设计输出日志的模块.

- 使用 session 而非 cookie 来存储登录状态, 同时也没有测试多客户端访问.

- 没有自动更新数据集的功能, 这个功能爬取数据量比较大, 最好不要一起运行.

- 同样, 可视化其实也是静态数据.

- 推荐和预测功能会同时启动 Java, 不确定会不会造成僵尸进程.
